<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.80.0" />
    <meta name="description" content="">


    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
    <title>Discovering Anomalies :: Red Hare Security Research</title>

    
    <link href="/css/nucleus.css?1613369229" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1613369229" rel="stylesheet">
    <link href="/css/hybrid.css?1613369229" rel="stylesheet">
    <link href="/css/featherlight.min.css?1613369229" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1613369229" rel="stylesheet">
    <link href="/css/auto-complete.css?1613369229" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1613369229" rel="stylesheet">
    <link href="/css/theme.css?1613369229" rel="stylesheet">
    <link href="/css/hugo-theme.css?1613369229" rel="stylesheet">
    
    <link href="/css/theme-mine.css?1613369229" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1613369229"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/dfir/dfir-001-ioc/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href='/'>
    <svg version="1.0" xmlns="http://www.w3.org/2000/svg" width="150.000000pt" height="64.000000pt" viewBox="0 0 300.000000 128.000000" preserveAspectRatio="xMidYMid meet">
 <metadata>
 Created by potrace 1.10, written by Peter Selinger 2001-2011
 </metadata>
 <g transform="translate(0.000000,128.000000) scale(0.050000,-0.050000)"
 fill="#000000" stroke="none">
 <path d="M980 2410 c-17 -45 -31 -54 -74 -48 -7 1 -30 -30 -50 -69 -26 -52
 -45 -68 -69 -59 -29 11 -31 0 -19 -96 l14 -108 -97 95 c-114 112 -137 107 -83
 -20 l39 -91 -43 -92 c-30 -64 -46 -145 -52 -262 -11 -215 -29 -262 -156 -410
 -175 -205 -189 -233 -203 -395 -23 -272 90 -440 287 -428 125 7 170 42 205
 158 37 122 126 241 214 285 42 22 121 75 175 118 97 78 152 73 152 -14 0 -10
 58 -137 128 -281 71 -145 144 -313 162 -373 75 -243 157 -269 242 -78 29 64
 66 128 82 141 16 14 65 88 109 166 44 77 116 191 159 251 136 190 158 229 158
 281 0 39 17 60 70 85 53 25 71 47 73 89 11 187 10 239 -7 272 -12 23 -13 44
 -1 56 26 26 -16 177 -48 177 -30 0 -65 -60 -54 -92 5 -12 -29 -56 -74 -97 -59
 -53 -77 -81 -62 -96 25 -25 83 14 83 57 0 16 9 28 20 28 38 0 20 -60 -30 -104
 -28 -24 -50 -57 -50 -75 -1 -27 -3 -27 -20 -1 -14 22 -19 23 -20 4 0 -14 30
 -38 66 -54 60 -25 66 -34 58 -99 -11 -96 -17 -94 -191 88 -83 88 -177 175
 -207 194 -40 24 -27 3 45 -74 218 -235 165 -264 -61 -34 -79 80 -183 174 -231
 209 -159 115 -279 231 -210 201 33 -14 79 -43 103 -65 88 -80 245 -190 271
 -190 30 0 -36 59 -213 187 -138 100 -326 203 -343 187 -6 -6 18 -26 53 -44 82
 -43 70 -53 -26 -24 -64 20 -74 31 -65 68 14 57 -22 78 -66 39 -113 -103 -157
 99 -91 422 16 79 -23 90 -52 15z m-50 -215 c-15 -70 -106 -225 -123 -209 -6 6
 -1 29 11 51 12 22 22 61 22 87 0 52 51 136 83 136 12 0 15 -25 7 -65z m-41
 -410 c-7 -247 -4 -234 -38 -206 -16 13 -24 37 -18 52 6 16 -3 34 -21 41 -34
 13 -45 68 -14 68 10 0 23 25 31 55 13 58 53 165 60 165 3 0 3 -79 0 -175z
 m122 -91 c-39 -94 -71 -199 -71 -233 0 -41 -10 -61 -30 -61 -32 0 -42 70 -13
 88 10 6 23 50 30 97 52 357 60 377 117 320 38 -38 38 -40 -33 -211z m359 -50
 c55 -49 134 -120 176 -158 45 -40 89 -64 106 -58 16 6 35 -2 41 -19 7 -17 23
 -27 37 -22 25 10 70 -65 70 -118 0 -15 22 -34 49 -41 56 -13 86 -81 53 -114
 -12 -12 -23 -40 -24 -63 -2 -34 -4 -35 -12 -6 -14 53 -64 44 -54 -10 5 -25 3
 -34 -3 -20 -17 34 -42 31 -42 -5 0 -16 8 -30 19 -30 10 0 14 -18 8 -40 -8 -31
 0 -40 34 -40 64 0 92 38 92 122 0 50 11 78 33 87 89 34 76 -177 -18 -290 -77
 -92 -104 -100 -87 -24 10 41 8 47 -7 25 -14 -20 -26 -23 -36 -9 -30 42 -146
 112 -170 102 -14 -5 -7 -11 15 -12 31 -1 34 -6 13 -19 -28 -17 48 -118 80
 -108 7 3 17 -12 23 -33 6 -27 1 -35 -18 -27 -16 5 -28 19 -28 29 0 11 -10 13
 -23 5 -13 -8 -18 -5 -11 6 7 11 -9 30 -37 43 -64 29 -62 19 10 -53 55 -55 68
 -144 20 -144 -9 0 -28 -5 -43 -10 -29 -12 -105 151 -165 354 -23 75 -47 118
 -72 126 -29 10 -35 25 -26 68 18 91 -241 146 -264 56 -29 -116 -139 -107 -115
 10 7 38 3 56 -14 56 -42 0 -11 165 57 308 35 71 63 134 63 139 0 6 9 34 20 63
 l20 53 65 -45 c36 -25 110 -85 165 -134z m-599 -116 c-11 -59 -6 -71 38 -91
 57 -26 59 -33 31 -107 l-20 -53 -89 77 c-105 89 -110 119 -36 200 67 72 93 64
 76 -26z m129 -327 c0 -65 -11 -88 -60 -124 -42 -31 -57 -56 -49 -81 7 -20 4
 -36 -5 -36 -10 0 -33 -27 -53 -60 -96 -163 -83 -22 17 180 112 227 150 258
 150 121z m-150 -1 c7 -11 -10 -49 -38 -85 -27 -36 -59 -90 -70 -120 -28 -73
 -184 -30 -159 44 21 60 246 196 267 161z m-349 -289 c-12 -29 -21 -81 -21
 -115 0 -50 -5 -57 -28 -38 -22 18 -31 18 -38 -2 -6 -14 -12 9 -12 51 -2 59 7
 79 36 87 21 5 43 29 49 52 6 23 17 37 23 31 6 -6 2 -36 -9 -66z m116 -12 c52
 -67 40 -143 -39 -239 l-41 -50 11 66 c7 41 4 61 -8 54 -11 -7 -20 1 -20 18 0
 16 8 34 17 40 10 6 14 47 9 92 -11 94 7 99 71 19z"/>
 <path d="M1212 1585 c3 -5 -3 -30 -12 -56 -11 -29 -11 -49 2 -53 11 -4 21 -27
 23 -51 4 -53 54 -61 57 -10 5 74 -6 116 -40 148 -20 17 -33 28 -30 22z"/>
 <path d="M1518 1350 c-2 -5 -4 -18 -5 -28 -2 -10 -9 -24 -16 -31 -15 -16 2
 -91 20 -91 31 1 74 39 45 40 -22 0 -19 10 10 37 21 21 44 34 52 30 7 -4 20 3
 28 16 8 14 6 18 -8 10 -11 -8 -27 -5 -34 7 -12 20 -88 29 -92 10z"/>
 <path d="M1580 1032 c0 -16 -11 -33 -25 -39 -19 -8 -19 -10 1 -11 15 -1 22 -9
 17 -18 -6 -9 18 -17 53 -18 35 -1 47 2 26 8 -29 8 -32 14 -11 27 22 13 22 21
 0 47 -32 40 -61 41 -61 4z"/>
 <path d="M1116 2355 c-18 -36 -39 -101 -45 -145 l-13 -80 41 65 c50 81 70 83
 54 5 -8 -38 -4 -60 10 -60 25 0 97 -77 97 -103 0 -9 14 -17 31 -17 16 0 35
 -13 42 -30 37 -96 193 41 264 232 18 50 -63 8 -130 -68 -117 -132 -222 -143
 -176 -20 26 70 -2 226 -40 226 -15 0 -32 -13 -38 -30 -22 -57 -59 -33 -46 30
 16 79 -10 76 -51 -5z"/>
 <path d="M1636 2115 c-39 -58 -77 -123 -84 -144 -11 -31 -18 -34 -31 -13 -21
 35 -45 -4 -28 -47 6 -18 25 -29 40 -23 15 6 27 -2 27 -19 0 -39 41 -37 100 6
 75 54 240 222 240 245 0 46 -60 14 -146 -80 -145 -158 -203 -140 -74 22 44 56
 80 114 80 130 0 59 -56 24 -124 -77z"/>
 <path d="M2262 2140 c-55 -44 -115 -107 -132 -139 -16 -32 -61 -83 -100 -112
 -72 -55 -137 -161 -119 -191 14 -23 109 27 154 80 19 23 44 42 55 42 34 0 22
 -59 -20 -105 -25 -26 -36 -57 -28 -80 6 -20 -3 -59 -21 -86 -25 -39 -26 -49
 -5 -49 28 0 114 81 114 108 0 9 23 34 50 56 46 35 53 93 9 65 -57 -35 19 59
 112 139 114 99 205 240 168 262 -11 7 -76 -42 -144 -108 -110 -109 -155 -141
 -155 -113 0 5 63 72 140 150 77 77 140 145 140 151 0 41 -130 -1 -218 -70z"/>
 <path d="M1882 1987 c-172 -185 -179 -196 -131 -215 21 -8 29 -1 25 23 -4 22
 7 35 28 35 19 0 46 12 59 25 14 14 34 25 46 26 37 1 111 74 111 109 0 19 18
 59 39 89 36 51 36 81 0 81 -8 0 -87 -78 -177 -173z"/>
 <path d="M4460 2079 c0 -11 14 -25 30 -32 19 -7 30 -38 30 -88 l0 -77 -104 -6
 c-169 -10 -255 -204 -167 -375 39 -74 55 -79 280 -79 177 -1 242 20 161 51
 -25 9 -30 64 -30 319 l0 308 -100 0 c-55 0 -100 -9 -100 -21z m56 -424 c-9
 -244 -145 -249 -145 -5 0 119 31 170 102 170 48 0 49 -2 43 -165z"/>
 <path d="M3080 2030 c0 -17 18 -30 40 -30 38 0 40 -13 40 -258 0 -241 -3 -258
 -40 -268 -104 -27 -33 -55 125 -50 153 6 226 37 120 52 -40 6 -45 18 -45 105
 0 148 55 137 161 -31 l83 -130 108 0 c83 0 108 7 108 30 0 17 -15 30 -33 30
 -33 0 -46 13 -139 145 l-53 75 51 40 c105 83 86 240 -35 291 -101 42 -491 41
 -491 -1z m415 -85 c62 -81 14 -176 -100 -196 l-75 -13 0 134 0 134 75 -13 c41
 -7 86 -28 100 -46z"/>
 <path d="M1691 1870 c-33 -26 -54 -54 -47 -61 18 -18 115 55 115 86 1 32 2 32
 -68 -25z"/>
 <path d="M3850 1828 c-71 -77 -75 -292 -5 -361 69 -70 298 -69 312 1 6 32 -2
 36 -61 25 -84 -16 -156 29 -156 98 0 46 7 49 110 49 l110 0 0 80 c0 158 -199
 227 -310 108z m178 -40 c24 -62 12 -88 -38 -88 -50 0 -62 26 -38 88 7 18 24
 32 38 32 14 0 31 -14 38 -32z"/>
 <path d="M3080 930 c0 -17 18 -30 40 -30 38 0 40 -13 40 -262 0 -245 -3 -262
 -40 -272 -113 -30 -37 -68 123 -62 156 6 242 44 133 59 -42 6 -46 17 -46 126
 l0 119 120 0 120 0 0 -119 c0 -109 -4 -120 -46 -126 -112 -15 -24 -53 126 -53
 150 0 238 38 126 53 -71 11 -73 523 -1 533 129 19 40 64 -125 64 -165 0 -254
 -45 -125 -64 40 -5 45 -17 45 -113 l0 -108 -120 0 -120 0 -6 103 c-6 94 -2
 104 46 122 90 34 34 60 -131 60 -128 0 -159 -6 -159 -30z"/>
 <path d="M4534 947 c-21 -21 5 -47 47 -47 62 0 60 -518 -2 -534 -88 -24 -21
 -56 128 -62 151 -6 222 33 113 62 -33 9 -40 27 -40 112 0 149 48 137 156 -37
 l86 -140 394 5 394 4 6 95 c7 112 -67 149 -80 40 -6 -53 -10 -55 -141 -61
 l-135 -6 0 111 0 111 80 0 c58 0 80 -8 80 -30 0 -17 18 -30 41 -30 56 0 51
 186 -6 196 -20 4 -35 -5 -35 -22 0 -25 -78 -54 -142 -54 -10 0 -18 50 -18 110
 l0 110 119 0 c107 0 119 -4 125 -45 13 -93 76 -66 76 34 l0 91 -280 0 c-236 0
 -280 -5 -280 -30 0 -17 18 -30 40 -30 38 0 40 -13 40 -270 l0 -270 -60 0 c-49
 0 -76 21 -149 115 l-90 114 59 47 c113 88 69 263 -76 303 -81 23 -429 29 -450
 8z m402 -91 c40 -40 30 -171 -15 -195 -104 -56 -141 -30 -141 99 l0 120 66 0
 c36 0 77 -11 90 -24z"/>
 <path d="M3935 767 c-23 -6 -35 -30 -35 -68 0 -61 33 -80 52 -31 30 77 148 45
 148 -40 0 -42 -9 -48 -78 -48 -149 0 -203 -65 -161 -192 26 -79 41 -84 254
 -84 162 0 224 23 158 60 -27 14 -33 51 -33 185 0 120 -8 173 -29 190 -31 26
 -219 45 -276 28z m165 -307 c0 -72 -5 -80 -50 -80 -56 0 -73 89 -26 136 47 47
 76 26 76 -56z"/>
 <path d="M4347 430 c-25 -66 11 -130 73 -130 62 0 98 64 73 130 -15 40 -131
 40 -146 0z"/>
 </g>
 </svg>


</a>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1613369229"></script>
<script type="text/javascript" src="/js/auto-complete.js?1613369229"></script>
<script type="text/javascript">
    
        var baseurl = "\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1613369229"></script>

    
  </div>
  
    <section id="homelinks">
      <ul>
        <li>
            <a class="padding" href='/'><i class='fas fa-home'></i> Home</a>
        </li>
      </ul>
    </section>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/dfir/" title="DFIR" class="dd-item
        parent
        
        
        ">
      <a href="/dfir/">
          <b>0. </b>DFIR
          
      </a>
      
      
        <ul>
          
          
          

        
          
            
            




 
  
    
      <li data-nav-id="/dfir/dfir-001-ioc/" title="Discovering Anomalies" class="dd-item active">
        <a href="/dfir/dfir-001-ioc/">
        Discovering Anomalies
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
        
    </ul>

    
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Red Hare Security Research</a> > <a href='/dfir/'>DFIR</a> > Discovering Anomalies
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#cyber-threat-intelligence-cti-and-indicators-of-compromise-ioc">Cyber Threat Intelligence (CTI) and Indicators of Compromise (IoC)</a></li>
    <li><a href="#identifying-anomalies">Identifying Anomalies</a></li>
    <li><a href="#checking-trusted-code-signing">Checking Trusted Code Signing</a>
      <ul>
        <li><a href="#signed-malware">Signed Malware</a></li>
      </ul>
    </li>
    <li><a href="#checking-entropy">Checking Entropy</a>
      <ul>
        <li><a href="#using-bytehist-for-visualizing-entropy">Using Bytehist for Visualizing Entropy</a></li>
      </ul>
    </li>
    <li><a href="#checking-for-portable-executables">Checking for Portable Executables</a></li>
    <li><a href="#final-takeaways">Final Takeaways</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
<div class="tags">

  <a class="tag-link" href="/tags/cyber-threat-intelligence">cyber threat intelligence</a>

  <a class="tag-link" href="/tags/forensics">forensics</a>

  <a class="tag-link" href="/tags/static-property-analysis">static property analysis</a>

</div>

        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Discovering Anomalies
            </h1>
          

        


<hr>
<p>How do you confirm that an executable is malware? Sounds like an odd question to ask, but incident response exists in the world because something happened that evaded antivirus detection. Refer to the following chart <em><strong>(image from Lenny Zeltser)</strong></em>:
<img src="/images/DFIR/LZChart1.png" alt="LZ">
Antivirus or sandboxes would be considered a <strong>fully-automated analysis</strong> of a suspected executable. As an attacker, you’d want to implement a payload that can evade anti-virus detection, so fully-automated analysis loses it&rsquo;s effectiveness especially when adversaries can bypass these defenses.</p>
<h2 id="cyber-threat-intelligence-cti-and-indicators-of-compromise-ioc">Cyber Threat Intelligence (CTI) and Indicators of Compromise (IoC)</h2>
<p><img src="/images/DFIR/DFIR001-LZChart2.png" alt="LZ2">
Following the chart, the next step would be <strong>static property analysis</strong>, these are things like <strong>strings, IP addresses, and file hashes</strong>. What good are these properties to our analysis? If in your property analysis of an executable there is an IP address which has a foreign geolocation does that make it malware? Of course not, this is just a theory, we don’t even know what the executable is doing.</p>
<blockquote>
<p>Incident responders may think their primary output is to stop the bad thing from happening now and again in the future. This is true, however incidents aren’t going to stop, and attackers are getting more sophisticated. To address the increasing sophistication of our adversaries, an equal or greater amount of sophistication is required from our responders. The primary output for incident responders is <strong>Cyber Threat Intelligence (CTI)</strong>. - <em><strong>(paraphrased) from Rob Lee at SANS</strong></em></p>
</blockquote>
<p><strong>CTI</strong> is yet another subfield which exists in infosec, which involves the use and creation of <strong>Indicators of Compromise (IoC)</strong>. Without diving too deep into this, the power behind <strong>CTI</strong> is that you can create an entire collection of discovered IoC’s, your “threat intelligence”, which can then be used as reference to hunt for threats on an enterprise environment. This is effective in the following ways:</p>
<ul>
<li>The process of creating and using <strong>CTI</strong> is effective both <strong>reactively</strong> and <strong>proactively</strong>. Think of incident response as a <strong>reactive</strong> action, where you are reacting to an active threat on the environment which was detected. This does not take into account dormant malware which hasn’t had the chance to run on the system. Rather, without <strong>CTI</strong> you can never <strong>proactively</strong> hunt for bad things, so you are simply waiting for something bad to happen before you can act.</li>
<li>By having a collection of <strong>IoC’s</strong> to reference, you not only can better hunt for the indicators on the environment during an incident, but responders will also have a better way to stop future bad things from happening on their environments. It is likely, especially when an organization is attacked by a sophisticated threat actor, that they will come back. But if you have <strong>IoC’s</strong> created from the last incident, you are better equipped to respond to the next attack.</li>
<li>As you keep developing your <strong>CTI</strong>, you may also begin to create a profile of the threat actors your organization has attracted from the <strong>CTI</strong> you’ve developed. It’s not just your organization, but many others worldwide which have begun to curate the tactics used by threat actors. The <strong>MITRE ATT&amp;CK®</strong> group has created a great list of information of the <strong>Advanced Persistant Threat’s (APT&rsquo;s)</strong> which have been discovered and currently being researched. Note that attributing an incident to one of these groups is very difficult, but if you have not just one, but several <strong>IoC’s</strong> which correlate to the same kinds of signatures an adversary uses, you can hypothesize more accurately! Lastly, you should rely on the threat intelligence you’ve developed instead of relying on the intelligence gathered from others. Not only is this lazy, but your organization is unique, the best intelligence is that which you’ve generated yourself from the indicators!</li>
</ul>
<h2 id="identifying-anomalies">Identifying Anomalies</h2>
<p>Alright well the above was a mouthful, but why does this matter for us? Well it begins with generating some IoC’s from anomalous characteristics. Focusing on executables, my approach will begin with checking the following properties of my <strong>target</strong>:</p>
<ul>
<li>Trusted Code Signing</li>
<li>Entropy</li>
<li>Portable Executables</li>
</ul>
<p>Here are the tools I used, all of them are free:</p>
<ul>
<li>FTK Imager</li>
<li>Sigcheck</li>
<li>Densityscout</li>
<li>Bytehist</li>
</ul>
<p>The first two properties can be checked using the tools <strong>SigCheck</strong> and <strong>Densityscout</strong> respectively. I will perform this analysis on a dead system from my <strong>Windows Virtual Machine</strong>. Since this is a virtual machine, once the tools are installed the best practice is to take advantage of the Virtual Machine environment and make a snapshot before we begin. A physical forensic image taken using the tool <strong>FTK Imager</strong> of my first computers hard drive, which is also a Windows machine, will serve as our target of analysis. You can do this on a live system, but it’s the evidence I have on hand. Mount this evidence, also using <strong>FTK Imager</strong>, and make sure to have the mount type and mount method set to <strong>Logical Only</strong> and <strong>File System / Read Only</strong> respectively.</p>
<p><img src="/images/DFIR/DFIR001-Lab1.png?height=400px" alt="DFIR001-Lab1"></p>
<h2 id="checking-trusted-code-signing">Checking Trusted Code Signing</h2>

<div class="notices tip" ><p>The steps for checking code signatures is done in this manner because our environment is a forensic image of a Windows machine. <strong>Some incident response projects have machines which are live and active</strong>. You can use Sigcheck to check live systems by using the code certificates already operating on the live system you are targeting! <strong>If you want to use Sigcheck on a live system, simply run the command without taking a copy of the target machines code certificates</strong>.</p>
</div>

<p>Some prerequisites before we test code signing signatures using <strong>Sigcheck</strong>. We need the certificates of our <strong>target</strong> to compare with the certificates of our <strong>analysis machine</strong>. The reason is the assumption that the <strong>target</strong> is suspicious and our <strong>analysis machine</strong> is clean, and has <strong>uncompromised software</strong> installed to compare to using the tool. For my target evidence, navigate to the path <strong>F:[root]\WINDOWS\system32\CatRoot</strong> and copy both folders onto our analysis machine. The two folders here are important!</p>
<p><img src="/images/DFIR/DFIR001-Lab2.png?height=150px" alt="DFIR001-Lab2"></p>
<p>Copy the two folders and rename the folder names by simply replacing the last <strong>&ldquo;E&rdquo;</strong> to <strong>&ldquo;9&rdquo;</strong>, I did this in a folder on my desktop, then place these <strong>victim certificates</strong> to our <strong>analysis machines Catroot</strong> folder.</p>
<p><img src="/images/DFIR/DFIR001-Lab3.png?height=150px" alt="DFIR001-Lab3"></p>
<p>Lastly we will restart the <strong>&ldquo;Cryptographic Services&rdquo;</strong> service, using the Windows search bar search and navigate to the <strong>&ldquo;Services&rdquo;</strong> application. Find the <strong>&ldquo;Cryptographic Services&rdquo;</strong> service, and restart it (right-click &ndash;&gt; restart).</p>
<p><img src="/images/DFIR/DFIR001-Lab4.png?height=400px" alt="DFIR001-Lab4"></p>
<p>Great! Now we can use <strong>Sigcheck</strong>. In PowerShell (I also have my environment setup where sigcheck is in the <strong>environment variables</strong>) use the following switches. The command takes awhile, also note that my target was a full physical image of a system running Windows XP. On my Virtual Machine which has <strong>2 Cores and 4 GB of RAM</strong>, it took approximately <strong>25 minutes to complete</strong> when directed at the targets <strong>Windows</strong> directory, malware can exist outside of this directory though! To analyze the code signatures, you would type the command in the PowerShell terminal:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PowerShell" data-lang="PowerShell">sigcheck -s -c -e -h -v -vt -w C:\Users\REWindows\Documents\Analysis\sigcheck-results.csv F:\<span style="color:#66d9ef">[root]</span>\WINDOWS
</code></pre></div><p>The switches call for the use of VirusTotal, however if you don&rsquo;t have internet connected to your analysis machine or don&rsquo;t want to upload the hashes onto VirusTotal you can omit the <strong>-vt</strong> switch. The output will be written in the file <strong>C:\Users\REWindows\Documents\Analysis\sigcheck-results.csv</strong> and Sigcheck will be run on the targets <strong>F:[root]\WINDOWS</strong> folder.</p>

<div class="notices note" ><p>Additional testing performing the above on the entire <strong>root</strong> of the evidence (the entire <strong>C:\</strong> drive) took approximately <strong>56 minutes to complete</strong>. Some background of the lab environment: Target Machine was a 60 gb physical image, stored on an external hard drive and connected via USB 3.0 and then mounted by FTK Imager. REWindows Analysis Virtual Machine is a Windows 10 environment which has <strong>2 cores and 4 gb of RAM</strong> allocated to it.</p>
</div>

<h3 id="signed-malware">Signed Malware</h3>
<p>Will malware be signed? <strong>It depends</strong>. The code certificate process is quite interesting. First you need a certificate to sign something. It&rsquo;s &ldquo;easy&rdquo; as an individual developer to obtain a code certificate, however the issue is in the authentication of this certificate. In order to get Microsoft to approve your software (so that your software can run on their operating system) you need money and identification. For an <strong>individual developer</strong>, identification could mean a passport, phone bill, or domain name. Signed code is useful as a <strong>hiding mechanism</strong>, however if software is deemed malicious and reported, the code certificate can be taken down, which removes the ability to hide your malware using code certificates. Furthermore, as a malware developer to ensure variants retain survivability after revoking their code certificate, a new certificate must be generated and approved for each variant in the event the code gets caught, otherwise all the software that’s associated with one code certificate can be deemed malicious and taken down.</p>
<p>Can code certificates be stolen and used as signatures? Yes. Statistically it is a low percentage of malware that is signed, and it is likely that adversaries that sign their malware for evasive purposes have mostly been <strong>nation states</strong>. <strong>Stuxnet</strong> and <strong>Flame</strong> malware was signed for example and both were developed by nation-states.</p>
<p>So how do we use <strong>Sigcheck</strong> for our detection? We will make the assumption that code certificates belonging to well known publishers like Microsoft and Google have not been compromised. That’s not to say they can’t be compromised, however the likelihood is really low. If you somehow suspect and prove that some code is indeed malicious, and it has the code signing certificate of these known publishers, you must be sitting on a huge infosec story!</p>
<p>Using <strong>Timeline Explorer</strong> or Excel if you have it, we can begin our detection by filtering the various categories. For simplicity, I wanted to check <strong>unverified</strong> software so I opened our output in Timeline Explorer and filtered the <strong>Verified</strong> column by unchecking Verified (Click the filter icon highlighted by the red box in the image).</p>
<p><img src="/images/DFIR/DFIR001-Lab5.png?height=300px" alt="DFIR001-Lab5"></p>
<p><img src="/images/DFIR/DFIR001-Lab6.png?height=200px" alt="DFIR001-Lab6"></p>
<p>7 files were apparently unverified in the Windows folder of my target. Does that mean these are malicious? <strong>Not necessarily</strong>, but perhaps we should look into these files. Scroll further to the right and we can see more categories generated by Sigcheck. I’ll focus on the categories:</p>
<ul>
<li>Publisher and Company</li>
<li>Hashes</li>
<li>Machine Type</li>
<li>File Name</li>
</ul>
<p>Publisher and Company if it’s <strong>“n/a”</strong> could be suspicious, <strong>hashes</strong> can be submitted and checked on VirusTotal or other open source malware repositories, and machine type denotes whether the architecture is <strong>32-bit or 64-bit</strong>. Could 32-bit malware exist in the System32 folder? It’s not supposed to, if you’re running a 64-bit operating system the executables within the <strong>System32 folder are 64-bit programs</strong> if they are standard Windows processes, your <strong>Syswow64 folder should contain 32-bit programs</strong>. Most malware is written in 32-bit because the malware author ensures that their code can be run on all Windows architecture platforms. This doesn&rsquo;t mean that all 32-bit software found on your 64-bit operating system is malicious!</p>
<p>Is the <strong>File Name</strong> familiar? Not all strange program names are malicious, but it’s often a technique to hide malware by using misspelled words. This is a technique to abuse human error of analysts, an example could be:</p>
<ul>
<li><strong>svchost.exe</strong></li>
<li><strong>scvhost.exe</strong></li>
<li><strong>svcbost.exe</strong></li>
</ul>
<p>When reviewing the above, and seeing several legitimate svchost processes, an analyst can make the error upon first review and miss the malicious process. This is also known as <strong>malware hiding in plain sight</strong>. This is just one way to <strong>help automate and detect anomalies</strong> on a system, it&rsquo;s better to have more than one trick.</p>
<h2 id="checking-entropy">Checking Entropy</h2>
<p>Entropy is a mathematical concept of calculating <strong>randomness</strong>. Why does this relate to us for anomaly detection? Knowledge of the randomness of a given file can tell us if an executable is <strong>packed</strong>. Malware authors pack their malware as a hiding technique to obfuscate the code and contents of malware so it can evade detection. This is achieved through <strong>compression</strong> which goes through the hexadecimal byte values of a file and observes the frequency of bytes which occur.</p>
<p><strong>Packed</strong> files appear to mathematically be <strong>uniform</strong> data and are a derivation of <strong>compression</strong>. In the english alphabet there is a frequency of occurrence that’s expected. English favours certain characters, the letter <strong>E</strong> for example is the most frequent in occurrence statistically, therefore if you did a <strong>frequency analysis</strong> from a page in a book, it’s expected that you would find more entropic data because of the higher frequency of certain characters. In this same scenario, compression eliminates entropy when a surge (higher frequency) in characters is detected, and would compress it down. Packed executables would result in a flat line.</p>
<p>Using the tool <strong>Densityscout</strong> it describes that any rating that is below abs-density of <strong>0.1</strong> is typical of <strong>packed</strong> files. Abs-density is explained by <strong>Densityscout</strong> as measuring “the average distance from the ideal quantity for each byte-state according to the overall byte-quantity of the evaluated file.” So we want to detect any potentially malicious executables that have an abs-density of less than <strong>0.1</strong>. You would type the command in the PowerShell terminal:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PowerShell" data-lang="PowerShell">densityscout -r -s exe,dll,sys -p 0.1 -o C:\Users\REWindows\Documents\Analysis\densityscsout-results.txt F:\<span style="color:#66d9ef">[root]</span>\WINDOWS
</code></pre></div><p><img src="/images/DFIR/DFIR001-Lab7.png?height=250px" alt="DFIR001-Lab7"></p>
<p>The above output took approximately <strong>27 minutes to complete</strong> in my setup and shows 3 files which had an abs-density lower than <strong>0.1</strong>, are these malicious? Again, <strong>not necessarily</strong>. This is only an automated detection technique looking for obfuscation and packed code. Based on detecting obfuscation, the file <strong>“WdfCoInstaller01007.dll”</strong> seems to be something to keep an eye on.</p>

<div class="notices note" ><p>Additional testing performing the above script on the entire <strong>root</strong> of the evidence (the entire <strong>C:\</strong> drive) took approximately <strong>36 minutes to complete</strong>.</p>
</div>

<h3 id="using-bytehist-for-visualizing-entropy">Using Bytehist for Visualizing Entropy</h3>
<p>Bonus section! To visualize the uniform data that is expressed and calculated by Densityscout, you can use the tool <strong>Bytehist</strong> to view the histogram. Shown in the image below, represented by the <strong>purple</strong> line I inserted in the screenshot to function as a pseudo-ruler, the histogram is relatively uniform with few peaks. This graphed uniformity of the frequency analysis, is likely what caused Densityscout to calculate the abs-density value to be less than 0.1.</p>
<p><img src="/images/DFIR/DFIR001-Lab8.png?height=250px" alt="DFIR001-Lab8"></p>
<p>To perform this, in the PowerShell terminal type the command:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PowerShell" data-lang="PowerShell">bytehist F:\<span style="color:#66d9ef">[root]</span>\WINDOWS\system32\WdfCoInstaller01007.dll
</code></pre></div><h2 id="checking-for-portable-executables">Checking for Portable Executables</h2>
<p>Portable executables (PE files) were introduced by Microsoft for the development of the new Win32 specifications (32-bit operating system) to the new NT platform, Windows NT 3.1. At this point the Windows operating system was being developed into a 32-bit operating system from the previous 16-bit designs. This is relevant to us because <strong>the intent of PE’s was to have a common file format that can run on all flavors of Windows, on all supported CPUs</strong>.</p>
<p>Present day, we know that Windows operating systems exist as 64-bit flavors and little has changed with PE file architectures to adjust to the 64-bit platform. Malware authors utilize PE file formats because they can run on all Windows platforms, meaning it is important for us to detect the usage of PE’s. <strong>Not all PE files are malicious</strong>, however it’s best we figure out a way to detect PE’s present on the file system. In keeping with the theme of free tools, there are many tools which can automate this process, however <strong>PEScanner</strong> from <strong>TZWorks</strong> has a perfect tool to automate recursively through a directory and it’s subdirectories, unfortunately it requires a license!</p>
<p>So is there a way to automate PE detection for free? <strong>GitHub</strong> has options, however our goal is to <strong>automate recursively through a directory and subdirectories</strong>. Some custom tooling will be needed. (or more research on my end). For now I’ll list off some tools that worked for me from GitHub which also are installed on <strong>REMnux</strong>:</p>
<ul>
<li>PEV Toolkit, using <strong>pescan</strong></li>
<li><strong>pedump</strong></li>
<li><strong>pefile</strong></li>
</ul>

<div class="notices note" ><p>I’ve had success on a singular file by file scenario with the tools above. However I must restate that unlike the other two discovery methods, this current issue is there doesn’t seem to be a <strong>free automation tool to recursively explore entire file systems for malicious PE’s</strong>. Maybe I should become a developer for some time to figure out a way.</p>
</div>

<h2 id="final-takeaways">Final Takeaways</h2>
<p>By now, this blog post has at least made you more familiar with the following:</p>
<ul>
<li>The importance of <strong>Threat Intelligence</strong> and <strong>Generating your own CTI</strong>.</li>
<li>How to automate the discovery of anomalies by targeting <strong>code signatures using Sigcheck</strong> and  <strong>Entropy / Obfuscation using Densityscout and Bytehist</strong>.</li>
</ul>
<p>Leaving us with <strong>PE’s</strong> and finding out how to automate the discovery of anomalies in them. I will (hopefully) revisit PE’s with a solution in the near future!</p>


<footer class="footline">
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="/dfir/" title="DFIR"> <i class="fa fa-chevron-left"></i></a>
		
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1613369229"></script>
    <script src="/js/perfect-scrollbar.min.js?1613369229"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1613369229"></script>
    <script src="/js/jquery.sticky.js?1613369229"></script>
    <script src="/js/featherlight.min.js?1613369229"></script>
    <script src="/js/highlight.pack.js?1613369229"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1613369229"></script>
    <script src="/js/learn.js?1613369229"></script>
    <script src="/js/hugo-learn.js?1613369229"></script>
    
        
            <script src="/mermaid/mermaid.js?1613369229"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>

